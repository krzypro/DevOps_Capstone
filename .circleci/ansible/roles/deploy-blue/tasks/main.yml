---
-   name:   Echo from shell
    command: |
        echo "Environment vars"
        echo $DOCKER_IMAGE_PREFIX
        echo $IMAGE_NAME
    register: out_env
-   name: Output echo 3
    ansible.builtin.debug:
        var: out_env
-   name: Creates directory
    file:
        path: "{{ home_dir }}/k8s"
        state: directory
-   name: Copy k8s definitions
    copy:
        src: ../../k8s/deployment.yml
        dest: "{{ home_dir }}/k8s/blue-deployment-{{ lookup('env', 'BUILD_ID') }}.yml"
-   name: Blue env - update image name
    replace:
        path: "{{ home_dir }}/k8s/blue-deployment-{{ lookup('env', 'BUILD_ID') }}.yml"
        regexp: "___IMAGE_NAME___"
        replace: "{{ lookup('env', 'IMAGE_NAME') }}"
        backup: no
-   name: Blue env - update build id
    replace:
        path: "{{ home_dir }}/k8s/blue-deployment-{{ lookup('env', 'BUILD_ID') }}.yml"
        regexp: "___BUILD_ID___"
        replace: "{{ lookup('env', 'BUILD_ID') }}"
        backup: no
-   name: Blue env - deploy services
    shell: kubectl apply -f "{{ home_dir }}/k8s/blue-deployment-{{ lookup('env', 'BUILD_ID') }}.yml"